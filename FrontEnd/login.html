<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9.40,100.1000;1,9.40,100.1000&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9.40,100.1000;1,9.40,100.1000&family=Inter:ital,opsz,wght@0,14.32,100.900;1,14.32,100.900&display=swap" rel="stylesheet">
  <title>Acesse sua conta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
  body {
    background-color: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 90vh;
    font-family: "DM Sans", sans-serif;
  }

  .login-card {
    width: 100%;
    max-width: 360px;
    padding: 1.5rem;
    background-color: #000;
  }

  .login-card img {
    width: 90px;
    display: block;
    margin: 0 auto 1rem;
  }

  .form-control {
    background-color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1rem;
  }

  .form-control:focus {
    box-shadow: none;
    border: 2px solid #00FF84;
  }

  .btn-login {
    background-color: #24D301;
    color: #000;
    font-weight: 600;
    border-radius: 8px;
    padding: 0.5rem;
  }

  .btn-login:hover {
    background-color: #28ee00;
    color: #000;
  }

  .div-google { margin-top: 0; }

  .google-btn {
    background-color: #fff;
    color: #000;
    font-weight: 500;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    padding: 0.65rem 1rem;
  }

  .google-btn img { width: 20px; height: 20px; margin: 0; }

  .forgot-password a {
    font-family: "Inter", sans-serif;
    color: #B9B9B9;
    text-decoration: underline;
  }

  .divider {
    height: 1px;
    background-color: #333;
    margin: 2.5rem 0 2.5rem 0;
  }

  .forgot-password { text-align: center; margin: 1rem; }

  .is-invalid { border: 2px solid #ff4d4f !important; }
  </style>
</head>
<body>

  <div class="login-card text-center">
    <img src="./assets/img/nave.png" alt="Logo">

    <h4 class="mb-4">Acesse sua conta</h4>

    <div id="formAlert" class="alert d-none" role="alert"></div>

    <form id="loginForm" novalidate>
      <div class="mb-3 text-start">
        <input id="email" type="email" class="form-control" placeholder="E-mail" required>
      </div>
      <div class="mb-2 text-start">
        <input id="password" type="password" class="form-control" placeholder="Senha" required>
      </div>

      <div class="forgot-password">
        <a href="#">Esqueci minha senha</a>
      </div>

      <button id="submitBtn" type="submit" class="btn btn-login w-50 mb-2">Entrar</button>
    </form>

    <div class="divider"></div>

    <div class="div-google">
      <button class="btn google-btn w-100 mb-4" type="button" disabled title="Em breve">
        <img src="./assets/img/Google-logo.png" alt="Google">
        <span>Continuar com o Google</span>
      </button>
    </div>

    <p style="font-family:'Inter', sans-serif; color: #B9B9B9;">Não tem uma conta?<br>
      <a href="cadastro.html" style="font-family:'Inter', sans-serif; color: #fff;">Cadastre-se</a>
    </p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
 <script>
  const API_BASE = (window.API_BASE || "http://localhost:8000/api").replace(/\/+$/,'');

  const form = document.querySelector("form");
  const emailInput = document.querySelector('input[type="email"], input[name="email"], #email');
  const passInput  = document.querySelector('input[type="password"], input[name="password"], #password');
  const submitBtn  = form ? form.querySelector('button[type="submit"], .btn-login') : null;

  function ensureAlertBox() {
    let box = document.getElementById("formAlert");
    if (!box) {
      box = document.createElement("div");
      box.id = "formAlert";
      box.className = "alert d-none";
      const title = document.querySelector("h4, h3, h2, h1");
      (title?.parentNode || document.body).insertBefore(box, title?.nextSibling || null);
    }
    return box;
  }
  function showAlert(msg, type="danger") {
    const box = ensureAlertBox();
    box.textContent = msg;
    box.className = `alert alert-${type}`;
  }
  function clearAlert(){ const box = document.getElementById("formAlert"); if (box){ box.className = "alert d-none"; box.textContent = ""; } }
  function setLoading(v){ if (submitBtn){ submitBtn.disabled = v; submitBtn.textContent = v ? "Entrando…" : "Entrar"; } }

  function decodeJwt(token){
    try{
      const base = token.split(".")[1];
      const json = atob(base.replace(/-/g, "+").replace(/_/g, "/"));
      return JSON.parse(json);
    }catch(_){ return null; }
  }

  async function tryEndpoints(payload){
    const variants = [
      { path: "/auth/login/",   body: { email: payload.email, password: payload.password } },
      { path: "/token/",        body: { username: payload.email, password: payload.password } },
      { path: "/auth/jwt/create/", body: { email: payload.email, password: payload.password } },
    ];

    for (const v of variants){
      try{
        const res = await fetch(`${API_BASE}${v.path}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(v.body),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) continue;

        const access  = data.access || data.access_token || data.token || null;
        const refresh = data.refresh || data.refresh_token || null;

        if (!access) continue;

        let user = data.user || null;
        if (!user){
          const payload = decodeJwt(access) || {};
          user = {
            id: payload.user_id || payload.sub || null,
            username: payload.username || null,
            email: (payload.email || null) ?? (v.body.email || null),
          };
        }

        return { access, refresh, user };
      }catch(_){}
    }
    throw new Error("Falha de autenticação");
  }

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAlert();

      const email = (emailInput?.value || "").trim().toLowerCase();
      const password = (passInput?.value || "");

      if (!email) { showAlert("Informe o e-mail."); emailInput?.focus(); return; }
      if (!password) { showAlert("Informe a senha."); passInput?.focus(); return; }

      setLoading(true);
      try{
        const result = await tryEndpoints({ email, password });

        if (result.access)  localStorage.setItem("access", result.access);
        if (result.refresh) localStorage.setItem("refresh", result.refresh);
        if (result.user)    localStorage.setItem("user", JSON.stringify(result.user));

        showAlert("Login realizado! Redirecionando…", "success");
        setTimeout(() => { window.location.href = "index.html"; }, 500);
      }catch(err){
        console.error(err);
        showAlert("Não foi possível entrar. Verifique e-mail/senha ou o endpoint da API.");
      }finally{
        setLoading(false);
      }
    });
  } else {
    console.warn("Formulário de login não encontrado na página.");
  }

</script>

</body>
</html>
