<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Pré-conexão com Google Fonts para melhorar performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Fontes DM Sans e Inter usadas na interface -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9.40,100.1000;1,9.40,100.1000&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9.40,100.1000;1,9.40,100.1000&family=Inter:ital,opsz,wght@0,14.32,100.900;1,14.32,100.900&display=swap" rel="stylesheet">
  <title>Acesse sua conta</title>
  <!-- Bootstrap base de estilos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
  /* Layout geral da página de login */
  body {
    background-color: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 90vh;
    font-family: "DM Sans", sans-serif;
  }

  /* Container do card de login */
  .login-card {
    width: 100%;
    max-width: 360px;
    padding: 1.5rem;
    background-color: #000;
  }

  /* Logo centralizado no topo do card */
  .login-card img {
    width: 90px;
    display: block;
    margin: 0 auto 1rem;
  }

  /* Estilo base dos campos de formulário */
  .form-control {
    background-color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1rem;
  }

  /* Destaque do campo quando está em foco */
  .form-control:focus {
    box-shadow: none;
    border: 2px solid #00FF84;
  }

  /* Botão principal de login */
  .btn-login {
    background-color: #24D301;
    color: #000;
    font-weight: 600;
    border-radius: 8px;
    padding: 0.5rem;
  }

  .btn-login:hover {
    background-color: #28ee00;
    color: #000;
  }

  .div-google { margin-top: 0; }

  /* Botão desabilitado "Continuar com o Google" (feature futura) */
  .google-btn {
    background-color: #fff;
    color: #000;
    font-weight: 500;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    padding: 0.65rem 1rem;
  }

  .google-btn img { width: 20px; height: 20px; margin: 0; }

  /* Link de "Esqueci minha senha" */
  .forgot-password a {
    font-family: "Inter", sans-serif;
    color: #B9B9B9;
    text-decoration: underline;
  }

  /* Linha divisória antes do bloco Google */
  .divider {
    height: 1px;
    background-color: #333;
    margin: 2.5rem 0 2.5rem 0;
  }

  .forgot-password { text-align: center; margin: 1rem; }

  /* Borda vermelha em campos inválidos na validação manual */
  .is-invalid { border: 2px solid #ff4d4f !important; }

  /* ============================
   RESPONSIVIDADE PARA TELAS MAIORES
   (tablets, notebooks e PCs)
   ============================ */

/* Tablets em diante (>= 768px) */
@media (min-width: 768px) {

  /* Evita body "travado" em 90vh */
  body {
    height: auto;
    min-height: 100vh;
  }

  /* Centraliza e limita largura dos conteúdos principais */
  .titulo,
  .title,
  .divider,
  .sobre-nos,
  .texto,
  .card-section,
  .event-info,
  form,
  .total-input,
  .mensagem-final {
    max-width: 960px;
    margin-left: auto;
    margin-right: auto;
  }

  /* Dá um respiro maior no topo da página */
  .titulo,
  .title {
    margin-top: 1.5rem;
  }

  /* Blocos "card-section" ficam parecidos em todas as telas */
  .card-section {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* Área de informações do evento (ingresso) fica mais organizada */
  .event-info {
    gap: 1.5rem;
  }

  .event-info img {
    max-width: 160px;
    width: 100%;
    height: auto;
  }

  /* Botões de ação principais: largura agradável no desktop */
  .btn-cart,
  .btn-confirmar,
  .btn-finalizar,
  .btn-voltar {
    width: 100%;
    max-width: 360px;
  }

  /* Texto da página "Sobre nós" um pouco mais confortável de ler */
  .sobre-nos .texto p {
    font-size: 1.1rem;
    line-height: 1.9rem;
  }

  /* Tela de embarque: conteúdo mais compacto em desktop */
  .content {
    max-width: 640px;
    margin-left: auto;
    margin-right: auto;
  }
}

/* Notebooks/monitores grandes (>= 1200px) */
@media (min-width: 1200px) {

  .titulo,
  .title,
  .divider,
  .sobre-nos,
  .texto,
  .card-section,
  .event-info,
  form,
  .total-input,
  .mensagem-final {
    max-width: 1040px;
  }

  /* Banner da home fica com largura controlada em telas enormes,
     mas ainda ocupando quase toda a linha */
  .banner-container {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
}

  </style>
</head>
<body>

  <!-- Card principal de login centralizado -->
  <div class="login-card text-center">
    <img src="./assets/img/nave.png" alt="Logo">

    <h4 class="mb-4">Acesse sua conta</h4>

    <!-- Caixa de alerta dinâmica (erros e sucessos do login) -->
    <div id="formAlert" class="alert d-none" role="alert"></div>

    <!-- Formulário de login (email + senha) -->
    <form id="loginForm" novalidate>
      <div class="mb-3 text-start">
        <input id="email" type="email" class="form-control" placeholder="E-mail" required>
      </div>
      <div class="mb-2 text-start">
        <input id="password" type="password" class="form-control" placeholder="Senha" required>
      </div>

      <div class="forgot-password">
        <a href="#">Esqueci minha senha</a>
      </div>

      <button id="submitBtn" type="submit" class="btn btn-login w-50 mb-2">Entrar</button>
    </form>

    <div class="divider"></div>

    <!-- Botão de login com Google (atualmente desabilitado) -->
    <div class="div-google">
      <button class="btn google-btn w-100 mb-4" type="button" disabled title="Em breve">
        <img src="./assets/img/Google-logo.png" alt="Google">
        <span>Continuar com o Google</span>
      </button>
    </div>

    <!-- Link para página de cadastro -->
    <p style="font-family:'Inter', sans-serif; color: #B9B9B9;">Não tem uma conta?<br>
      <a href="cadastro.html" style="font-family:'Inter', sans-serif; color: #fff;">Cadastre-se</a>
    </p>
  </div>

  <!-- JS do Bootstrap (componentes como modal, offcanvas etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // Define a URL base da API (pode ser sobrescrita por window.API_BASE)
  // e remove barras extras no final para evitar "///"
  const API_BASE = (window.API_BASE || "http://localhost:8000/api").replace(/\/+$/,'');

  // Referências principais do formulário e campos
  const form = document.querySelector("form");
  const emailInput = document.querySelector('input[type="email"], input[name="email"], #email');
  const passInput  = document.querySelector('input[type="password"], input[name="password"], #password');
  const submitBtn  = form ? form.querySelector('button[type="submit"], .btn-login') : null;

  /**
   * Garante que exista uma caixa de alerta (#formAlert) na página.
   * Se não existir, cria dinamicamente logo abaixo do título.
   */
  function ensureAlertBox() {
    let box = document.getElementById("formAlert");
    if (!box) {
      box = document.createElement("div");
      box.id = "formAlert";
      box.className = "alert d-none";
      const title = document.querySelector("h4, h3, h2, h1");
      (title?.parentNode || document.body).insertBefore(box, title?.nextSibling || null);
    }
    return box;
  }

  /**
   * Exibe uma mensagem na caixa de alerta.
   * @param {string} msg - Mensagem a ser exibida
   * @param {string} type - Tipo de alerta (danger, success, warning...)
   */
  function showAlert(msg, type="danger") {
    const box = ensureAlertBox();
    box.textContent = msg;
    box.className = `alert alert-${type}`;
  }

  /**
   * Esconde a caixa de alerta e limpa o texto.
   */
  function clearAlert(){
    const box = document.getElementById("formAlert");
    if (box){
      box.className = "alert d-none";
      box.textContent = "";
    }
  }

  /**
   * Ativa/desativa estado de carregamento do botão de submit.
   * Troca o texto do botão durante a requisição.
   */
  function setLoading(v){
    if (submitBtn){
      submitBtn.disabled = v;
      submitBtn.textContent = v ? "Entrando…" : "Entrar";
    }
  }

  /**
   * Decodifica o payload de um JWT (sem validar assinatura).
   * Útil para extrair user_id, email etc. de tokens de acesso.
   */
  function decodeJwt(token){
    try{
      const base = token.split(".")[1];
      const json = atob(base.replace(/-/g, "+").replace(/_/g, "/"));
      return JSON.parse(json);
    }catch(_){
      return null;
    }
  }

  /**
   * Tenta autenticar contra vários endpoints possíveis.
   * Isso torna o front mais resiliente a mudanças de rota no backend.
   *
   * Retorna um objeto { access, refresh, user } em caso de sucesso.
   */
  async function tryEndpoints(payload){
    const variants = [
      // DRF SimpleJWT customizado
      { path: "/auth/login/",   body: { email: payload.email, password: payload.password } },
      // Token padrão do Django (/api/token/)
      { path: "/token/",        body: { username: payload.email, password: payload.password } },
      // Outro padrão de JWT
      { path: "/auth/jwt/create/", body: { email: payload.email, password: payload.password } },
    ];

    // Testa cada endpoint em sequência até algum retornar 200
    for (const v of variants){
      try{
        const res = await fetch(`${API_BASE}${v.path}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(v.body),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) continue;

        // Mapeia possíveis nomes de campos de token
        const access  = data.access || data.access_token || data.token || null;
        const refresh = data.refresh || data.refresh_token || null;

        if (!access) continue;

        // Tenta pegar dados do usuário no próprio retorno
        let user = data.user || null;
        if (!user){
          // Se não veio "user" no JSON, extrai infos do JWT
          const payload = decodeJwt(access) || {};
          user = {
            id: payload.user_id || payload.sub || null,
            username: payload.username || null,
            // garante que o email apareça mesmo se só estiver no body
            email: (payload.email || null) ?? (v.body.email || null),
          };
        }

        return { access, refresh, user };
      }catch(_){
        // Falha silenciosa: parte pra próxima variante
      }
    }
    throw new Error("Falha de autenticação");
  }

  // Só adiciona o listener se o form realmente existir no DOM
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAlert();

      // Normaliza entrada do usuário
      const email = (emailInput?.value || "").trim().toLowerCase();
      const password = (passInput?.value || "");

      // Validações básicas de front
      if (!email) {
        showAlert("Informe o e-mail.");
        emailInput?.focus();
        return;
      }
      if (!password) {
        showAlert("Informe a senha.");
        passInput?.focus();
        return;
      }

      setLoading(true);
      try{
        // Tenta autenticar no backend
        const result = await tryEndpoints({ email, password });

        // Persiste tokens e dados do usuário no localStorage
        if (result.access)  localStorage.setItem("access", result.access);
        if (result.refresh) localStorage.setItem("refresh", result.refresh);
        if (result.user)    localStorage.setItem("user", JSON.stringify(result.user));

        showAlert("Login realizado! Redirecionando…", "success");

        // Redireciona para a home após login bem-sucedido
        setTimeout(() => { window.location.href = "index.html"; }, 500);
      }catch(err){
        console.error(err);
        showAlert("Não foi possível entrar. Verifique e-mail/senha ou o endpoint da API.");
      }finally{
        setLoading(false);
      }
    });
  } else {
    console.warn("Formulário de login não encontrado na página.");
  }

  </script>

</body>
</html>

