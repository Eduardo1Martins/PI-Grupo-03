<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Pré-conexão com Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <!-- Fontes usadas nos textos -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet" />
  <title>Cadastre-se</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* Layout geral da página de cadastro */
    body {
      background-color: #000;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 90vh;
      font-family: "DM Sans", sans-serif;
    }
    /* Card central do formulário de cadastro */
    .login-card {
      width: 100%;
      max-width: 380px;
      padding: 1.5rem;
      background-color: #000;
    }
    .login-card img {
      width: 90px;
      display: block;
      margin: 0 auto 1rem;
    }
    /* Campos do formulário */
    .form-control {
      background-color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1rem;
    }
    .form-control:focus { box-shadow: none; border: 2px solid #00ff84; }

    /* Botão de "Cadastrar" */
    .btn-login {
      background-color: #24d301;
      color: #000;
      font-weight: 600;
      border-radius: 8px;
      margin-top: 0.5rem;
      padding: 0.6rem;
    }
    .btn-login:hover { background-color: #28ee00; color: #000; }

    /* Botão Google (futuro) */
    .google-btn {
      background-color: #fff;
      color: #000;
      font-weight: 500;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      padding: 0.65rem 1rem;
    }
    .google-btn img { width: 20px; height: 20px; margin: 0; }

    /* Linha divisória entre partes do card */
    .divider { height: 1px; background-color: #333; margin: 2rem 0; }

    .forgot-password { text-align: center; margin: 1rem; }
    .forgot-password a { color: #fff; text-decoration: underline; font-family: "Inter", sans-serif; }
    .forgot-password p { color: #b9b9b9; font-family: "Inter", sans-serif; }

    /* Borda vermelha em campos inválidos na validação */
    .is-invalid { border: 2px solid #ff4d4f !important; }
  </style>
</head>
<body>
  <!-- Card principal do fluxo de cadastro -->
  <div class="login-card text-center">
    <img src="./assets/img/nave.png" alt="Logo" />
    <h3 class="mb-4">Cadastre-se</h3>

    <!-- Caixa de alertas (erros / sucesso) -->
    <div id="formAlert" class="alert d-none" role="alert"></div>

    <!-- Formulário de registro de usuário -->
    <form id="registerForm" novalidate>
      <div class="mb-3 text-start">
        <input id="email" name="email" type="email" class="form-control" placeholder="seu@email.com" required />
      </div>

      <div class="mb-3 text-start">
        <input id="nome" name="nome" type="text" class="form-control" placeholder="Seu nome" />
      </div>

      <div class="mb-3 text-start">
        <input id="cpf" name="cpf" type="text" class="form-control" placeholder="000.000.000-00" required />
      </div>

      <div class="mb-3 text-start">
        <input id="telefone" name="telefone" type="tel" class="form-control" placeholder="(11) 99999-9999" required />
      </div>

      <div class="mb-4 text-start">
        <input id="password" name="password" type="password" class="form-control" placeholder="Sua senha" required />
      </div>

      <button id="submitBtn" type="submit" class="btn btn-login w-100">Cadastrar</button>
    </form>

    <div class="divider"></div>

    <!-- Botão "Continuar com o Google" (desabilitado por enquanto) -->
    <button class="btn google-btn w-100 mb-3" type="button" disabled title="Em breve">
      <img src="./assets/img/Google-logo.png" alt="Google" />
      <span>Continuar com o Google</span>
    </button>

    <!-- Link para quem já tem conta -->
    <div class="forgot-password">
      <p>Já possui uma conta?<br /><a href="login.html">Entrar</a></p>
    </div>
  </div>

  <!-- Script do Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // URL base da API (pode ser sobrescrita via window.API_BASE)
    const API_BASE = window.API_BASE || "http://localhost:8000/api";

    // Atalho simples pra querySelector
    const $ = (sel) => document.querySelector(sel);

    // Referências principais da página
    const alertBox = $("#formAlert");
    const form = $("#registerForm");
    const submitBtn = $("#submitBtn");

    /**
     * Exibe mensagem de alerta no topo do card de cadastro.
     * @param {string} message - Texto a ser exibido.
     * @param {string} type - Tipo do alerta (danger, success, warning, info).
     */
    function showAlert(message, type = "danger") {
      alertBox.className = `alert alert-${type}`;
      alertBox.textContent = message;
      alertBox.classList.remove("d-none");
    }

    /**
     * Esconde a caixa de alerta e limpa o texto.
     */
    function clearAlert() {
      alertBox.className = "alert d-none";
      alertBox.textContent = "";
    }

    /**
     * Define o estado de carregamento do botão "Cadastrar".
     * Desabilita o botão e troca o texto durante a requisição.
     */
    function setLoading(loading) {
      submitBtn.disabled = loading;
      submitBtn.textContent = loading ? "Cadastrando…" : "Cadastrar";
    }

    // ====== Máscaras simples (CPF/telefone) ======

    // Campo CPF com máscara incremental (000.000.000-00)
    const cpfInput = $("#cpf");
    cpfInput.addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 11) v = v.slice(0, 11);
      if (v.length > 9)      v = v.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/, "$1.$2.$3-$4");
      else if (v.length > 6) v = v.replace(/^(\d{3})(\d{3})(\d{0,3}).*/, "$1.$2.$3");
      else if (v.length > 3) v = v.replace(/^(\d{3})(\d{0,3}).*/, "$1.$2");
      e.target.value = v;
    });

    // Campo telefone com máscara incremental, suportando 10 ou 11 dígitos
    const telInput = $("#telefone");
    telInput.addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 11) v = v.slice(0, 11);
      if (v.length > 10)      v = v.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
      else if (v.length > 6)  v = v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
      else if (v.length > 2)  v = v.replace(/^(\d{2})(\d{0,5}).*/, "($1) $2");
      else                    v = v.replace(/^(\d*)/, "($1");
      e.target.value = v;
    });

    // ====== CSRF (só se necessário em mesmo domínio) ======

    /**
     * Lê um cookie pelo nome.
     * Usado apenas se o frontend estiver servindo a partir do mesmo domínio do backend.
     */
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
    }

    // ====== Submissão do formulário de cadastro ======
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAlert();

      // Coleta campos do formulário
      const email = $("#email");
      const password = $("#password");
      const nome = $("#nome");
      const cpf = $("#cpf");
      const telefone = $("#telefone");

      // Remove estado de erro anterior
      [email, password, cpf, telefone].forEach((el) => el.classList.remove("is-invalid"));

      // Validações básicas de frontend
      if (!email.value || !email.validity.valid) {
        email.classList.add("is-invalid");
        return showAlert("Informe um e-mail válido.");
      }
      if (!password.value || password.value.length < 6) {
        password.classList.add("is-invalid");
        return showAlert("Senha deve ter pelo menos 6 caracteres.");
      }
      if (!cpf.value || cpf.value.replace(/\D/g, "").length !== 11) {
        cpf.classList.add("is-invalid");
        return showAlert("Informe um CPF válido (11 dígitos).");
      }
      if (!telefone.value || telefone.value.replace(/\D/g, "").length < 10) {
        telefone.classList.add("is-invalid");
        return showAlert("Informe um telefone válido.");
      }

      // Monta payload no formato esperado pelo backend
      const payload = {
        email: email.value.trim().toLowerCase(),
        password: password.value,
        nome: nome.value.trim() || undefined,
        cpf: cpf.value.trim(),
        telefone: telefone.value.trim(),
      };

      setLoading(true);
      try {
        // Cabeçalhos padrão da requisição
        const headers = { "Content-Type": "application/json" };

        try {
          // Se API e front estiverem no mesmo domínio, tenta enviar CSRF token
          const sameOrigin =
            location.origin.includes("localhost:8000") ||
            location.origin === new URL(API_BASE).origin;

          const csrftoken = getCookie("csrftoken");
          if (sameOrigin && csrftoken) headers["X-CSRFToken"] = csrftoken;
        } catch (_) {
          // Se der erro aqui, segue sem CSRF (ex: domínios diferentes)
        }

        // Chamada de registro para o endpoint REST do backend
        const res = await fetch(`${API_BASE}/auth/register/`, {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));

        // Trata erros de validação retornados pelo backend
        if (!res.ok) {
          if (data && typeof data === "object") {
            // Ordem de prioridade na leitura das mensagens de erro
            const fieldOrder = ["email", "password", "cpf", "telefone", "non_field_errors", "detail"]; 
            for (const f of fieldOrder) {
              if (data[f]) {
                // Marca o campo correspondente como inválido, se existir no DOM
                if ($("#" + f)) $("#" + f).classList.add("is-invalid");
                const msg = Array.isArray(data[f]) ? data[f][0] : String(data[f]);
                showAlert(msg || "Erro ao registrar.");
                break;
              }
            }
            // Se não tiver mensagem específica, mostra uma genérica
            if (!alertBox.textContent) showAlert("Não foi possível concluir o cadastro.");
          } else {
            showAlert("Erro inesperado ao registrar.");
          }
          return;
        }

        // Sucesso: guarda tokens e prossegue
        if (data.access)  localStorage.setItem("access", data.access);
        if (data.refresh) localStorage.setItem("refresh", data.refresh);

        showAlert("Cadastro realizado com sucesso! Redirecionando…", "success");

        // Redireciona para home após criar a conta
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1200);
      } catch (err) {
        console.error(err);
        showAlert("Falha de conexão com o servidor.");
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
