<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adquira seu ingresso</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'DM Sans', sans-serif;
      height: 90vh;
    }

    .navbar-brand img {
      height: 30px;
    }

    .navbar-toggler-icon {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='black' stroke-width='2' stroke-linecap='round' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
}

    .titulo {
    display: flex;
    margin: 0.75rem;
    margin-top: 1rem;
}

    h3 {
    padding-left: 0.5rem;
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.4;
    }

.divider {
  height: 1px;
  background-color: #e3e3e3;
  margin: 0.5rem;  
  margin-top: 0.25rem;
}

    .event-info {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin: 1.5rem;
    }

    .event-info img {
      width: 90px;
      height: 90px;
      border-radius: 10px;
      object-fit: cover;
    }

    .event-details h5 {
      font-weight: 700;
      margin-bottom: 0;
    }

    .event-details p {
      margin: 0;
      color: #b9b9b9;
    }

    .card-section {
      background-color: #000;
      border: 1px solid #ffffff;
      border-radius: 8px;
      padding: 1rem;
      margin: 1.5rem;
    }

    .card-section h6 {
      font-weight: 600;
      border-bottom: 1px solid #ffffff;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .item-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item-line .price {
      font-weight: 600;
    }

    .counter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .counter button {
      border: none;
      background-color: #00ff84;
      color: #000;
      font-weight: 700;
      width: 28px;
      height: 28px;
      border-radius: 6px;
    }

    .total-box {
        display: flex;
        justify-content: center;
        padding: 0;
        margin: 0;
        margin-bottom: 3.5rem;
    }
    .total-input {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 1rem;
      color: #000;
      width: 85%;
    }

    .btn-cart {
      background-color: #24D301;
      color: #000;
      font-weight: 600;
      width: 90%;
      max-width: 350px;
      border-radius: 8px;
      padding: 0.75rem;
      display: block;
      margin: 1rem auto;
    }

    .btn-cart:hover {
      background-color: #2ff500;
      color: #000;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark" style="background-color: #24D301;">
  <div class="container-fluid d-flex justify-content-between align-items-center ms-1 me-1">

    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral" aria-controls="menuLateral">
      <span class="navbar-toggler-icon"></span>
    </button>

    <a class="navbar-brand fw-bold text-dark" href="#">
      <img src="./assets/img/logo.png" alt="Logo" height="30">
    </a>

    <div class="d-flex align-items-center gap-3">
  <a href="carrinho.html" class="text-dark position-relative" aria-label="Abrir carrinho">
    <i class="bi bi-cart3 fs-2"></i>
    <span id="cart-count-badge"
          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          style="display:none; font-size:.7rem; min-width:1.1rem; height:1.1rem; padding:0; line-height:1.1rem;">
      0
    </span>
  </a>
  <a href="conta.html" class="text-dark" aria-label="Minha conta">
    <i class="bi bi-person-circle fs-2"></i>
  </a>
</div>
</nav>

<div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="menuLateral" aria-labelledby="menuLateralLabel">
  <div class="offcanvas-header">
    <h2 class="offcanvas-title" id="menuLateralLabel">Menu</h2>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
  </div>
  <div class="menu-divider"></div>
  <div class="offcanvas-body">
    <ul class="list-unstyled">
      <li><a href="index.html" class="text-white text-decoration-none d-block py-2">Eventos</a></li>
      <li><a href="sobre.html" class="text-white text-decoration-none d-block py-2">Sobre Nós</a></li>
      <li><a href="#" class="text-white text-decoration-none d-block py-2">Conta</a></li>
      <li><a href="#" class="text-white text-decoration-none d-block py-2">Sair</a></li>
    </ul>
    <div class="d-flex justify-content-start gap-4 mt-3">
  <a href="#" class="text-white fs-1"><i class="bi bi-instagram"></i></a>
  <a href="#" class="text-white fs-1"><i class="bi bi-tiktok"></i></a>
  <a href="#" class="text-white fs-1"><i class="bi bi-whatsapp"></i></a>
</div>
  </div>
</div>

<section class="titulo">
<a href="index.html" class="text-white fs-2 text-decoration-none p-1"><i class="bi bi-arrow-left"></i></a>
<h3 class="title fw-bold mb-0">Adquira seu ingresso</h3>
</section>

<div class="divider mb-4"></div>

  <div class="event-info">
    <img id="evento-img" src="./assets/img/banner-ArvoreDaVida.png" alt="Árvore da Vida">
    <div class="event-details">
      <h5 id="nome-evento"></h5>
      <p id="local-evento"></p>
      <p id="data-evento"></p>
    </div>
  </div>

  <div class="card-section">
    <h6>Ingresso do Evento</h6>
    <div class="item-line">
      <span id="nome-ingresso-evento"></span>
      <div class="d-flex align-items-center gap-3">
        <span id="preco-ingresso-evento" class="price"></span>
        <div class="counter">
          <button>-</button>
          <span>1</span>
          <button>+</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card-section">
    <h6>Ingresso da Excursão</h6>
    <div class="item-line">
      <span id="nome-excursao-evento"></span>
      <div class="d-flex align-items-center gap-3">
        <span id="preco-excursao-evento" class="price"></span>
        <div class="counter">
          <button>-</button>
          <span>1</span>
          <button>+</button>
        </div>
      </div>
    </div>
  </div>

   <div class="total-box">
  <div class="total-input">
    <span>Total:</span>
    <span id="preco-total"></span>
  </div>
  </div>

  <button class="btn btn-cart">Adicionar ao Carrinho</button>


  <script>
  const API_BASE = 'http://localhost:8000/api';

  // Se você usar JWT, pode recuperar o token daqui (ajuste conforme seu front)
  function getToken() {
    const candidates = ['token', 'access', 'jwt'];
    for (const k of candidates) {
      const v = localStorage.getItem(k);
      if (v) return v;
    }
    return null;
  }

  const baseHeaders = { 'Accept': 'application/json' };
  const jwt = getToken();
  if (jwt) baseHeaders['Authorization'] = `Bearer ${jwt}`;

  function formatDateBR(iso) {
    if (!iso) return '';
    const [y, m, d] = String(iso).split('-');
    if (!y || !m || !d) return iso;
    return `${d}/${m}`;
  }

  function formatMoneyBR(value) {
    const n = Number(value) || 0;
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(n);
  }

  const params = new URLSearchParams(window.location.search);
  const eventoId = params.get('evento');

  if (!eventoId) {
    document.body.innerHTML = "<h3 class='text-center mt-5'>Evento não encontrado.</h3>";
  } else {
    carregarEvento(eventoId);
  }

  async function carregarEvento(id) {
    try {
      const resp = await fetch(`${API_BASE}/eventos/${id}/`, {
        headers: baseHeaders
      });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

      const ev = await resp.json();

      // Mapeia a resposta da API para o objeto usado pelo resto da página
      const evento = {
        id: ev.id,
        nome: ev.nome,
        local: `${ev.cidade} - ${ev.local}`,
        data: ev.data,        // 'YYYY-MM-DD'
        imagem: ev.imagem,    // URL da imagem (ajuste se necessário)
        ingresso: {
          nome: `Ingresso ${ev.nome}`,
          preco: Number(ev.ingresso)
        },
        excursao: {
          nome: `Excursão ${ev.nome}`,
          preco: Number(ev.excursao || 0)
        }
      };

      // Deixa visível para o segundo <script>
      window.evento = evento;
      window.eventoParam = String(id);

      preencherTela(evento);
    } catch (err) {
      console.error(err);
      document.body.innerHTML = "<h3 class='text-center mt-5'>Evento não encontrado.</h3>";
    }
  }

  function preencherTela(evento) {
    const img = document.getElementById("evento-img");
    if (img) img.src = evento.imagem || "./assets/img/placeholder.png";

    document.getElementById("nome-evento").textContent = evento.nome;
    document.getElementById("local-evento").textContent = evento.local;
    document.getElementById("data-evento").textContent = formatDateBR(evento.data);

    document.getElementById("nome-ingresso-evento").textContent = evento.ingresso.nome;
    document.getElementById("preco-ingresso-evento").textContent = formatMoneyBR(evento.ingresso.preco);

    document.getElementById("nome-excursao-evento").textContent = evento.excursao.nome;
    document.getElementById("preco-excursao-evento").textContent = formatMoneyBR(evento.excursao.preco);

    const total = (evento.ingresso.preco || 0) + (evento.excursao.preco || 0);
    document.getElementById("preco-total").textContent = formatMoneyBR(total);
  }
</script>



<script>
  const CART_KEY = 'cart:v1';
  const money = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

  const CartStore = {
    load() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || { items: [] }; }
      catch { return { items: [] }; }
    },
    save(state) {
      state.updatedAt = new Date().toISOString();
      state.total = calcTotal(state.items);
      localStorage.setItem(CART_KEY, JSON.stringify(state));
    },
    clear() {
      localStorage.removeItem(CART_KEY);
    }
  };

  function calcTotal(items) {
    return items.reduce((acc, it) => {
      return acc + (Number(it.unitPrice || 0) * Number(it.qty || 0));
    }, 0);
  }

  const sections = document.querySelectorAll('.card-section');
  const ingressoSection = sections[0];
  const excursaoSection  = sections[1];

  function setupCounter(section) {
    if (!section) return;
    const btns = section.querySelectorAll('.counter button');
    const qtySpan = section.querySelector('.counter span');
    if (!btns.length || !qtySpan) return;

    function setQty(n) {
      const v = Math.max(0, n);
      qtySpan.textContent = String(v);
      updateTotal();
    }

    btns[0].addEventListener('click', () => setQty(parseInt(qtySpan.textContent, 10) - 1));
    btns[1].addEventListener('click', () => setQty(parseInt(qtySpan.textContent, 10) + 1));
  }

  setupCounter(ingressoSection);
  setupCounter(excursaoSection);

  const totalSpan = document.getElementById('preco-total');

  function getQty(section) {
    if (!section) return 0;
    const span = section.querySelector('.counter span');
    return span ? (parseInt(span.textContent, 10) || 0) : 0;
  }

  function updateTotal() {
    if (!window.evento) return;
    const ev = window.evento;

    const qIngress = getQty(ingressoSection);
    const qExcurs  = getQty(excursaoSection);

    const total = (ev.ingresso.preco * qIngress) + (ev.excursao.preco * qExcurs);
    if (totalSpan) totalSpan.textContent = money.format(total);
  }

  updateTotal();

  const btnCart = document.querySelector('.btn.btn-cart');
  if (btnCart) {
    btnCart.addEventListener('click', () => {
      if (!window.evento || !window.eventoParam) {
        alert('Evento ainda está carregando, tenta de novo em alguns segundos.');
        return;
      }

      const ev = window.evento;
      const eventoParam = String(window.eventoParam);

      const qIngress = getQty(ingressoSection);
      const qExcurs  = getQty(excursaoSection);

      const items = [];

      if (qIngress > 0) {
        items.push({
          id: `event:${eventoParam}:ingresso`,
          eventoId: eventoParam,
          name: document.getElementById('nome-ingresso-evento').textContent.trim(),
          unitPrice: Number(ev.ingresso.preco),
          qty: qIngress,
          kind: 'ingresso'
        });
      }

      if (qExcurs > 0) {
        items.push({
          id: `event:${eventoParam}:excursao`,
          eventoId: eventoParam,
          name: document.getElementById('nome-excursao-evento').textContent.trim(),
          unitPrice: Number(ev.excursao.preco),
          qty: qExcurs,
          kind: 'excursao'
        });
      }

      if (!items.length) {
        alert('Selecione pelo menos 1 item para adicionar ao carrinho.');
        return;
      }

      const state = CartStore.load();
      for (const it of items) {
        const existing = state.items.find(x => x.id === it.id);
        if (existing) existing.qty += it.qty;
        else state.items.push(it);
      }

      CartStore.save(state);

      window.location.href = 'carrinho.html';
    });
  }
</script>


<script src="js/cart-badge.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
