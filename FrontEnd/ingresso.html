<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adquira seu ingresso</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'DM Sans', sans-serif;
      height: 90vh;
    }

    .navbar-brand img {
      height: 30px;
    }

    .navbar-toggler-icon {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='black' stroke-width='2' stroke-linecap='round' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
}

    .titulo {
    display: flex;
    margin: 0.75rem;
    margin-top: 1rem;
}

    h3 {
    padding-left: 0.5rem;
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.4;
    }

.divider {
  height: 1px;
  background-color: #e3e3e3;
  margin: 0.5rem;  
  margin-top: 0.25rem;
}

    .event-info {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin: 1.5rem;
    }

    .event-info img {
      width: 90px;
      height: 90px;
      border-radius: 10px;
      object-fit: cover;
    }

    .event-details h5 {
      font-weight: 700;
      margin-bottom: 0;
    }

    .event-details p {
      margin: 0;
      color: #b9b9b9;
    }

    .card-section {
      background-color: #000;
      border: 1px solid #ffffff;
      border-radius: 8px;
      padding: 1rem;
      margin: 1.5rem;
    }

    .card-section h6 {
      font-weight: 600;
      border-bottom: 1px solid #ffffff;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .item-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item-line .price {
      font-weight: 600;
    }

    .counter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .counter button {
      border: none;
      background-color: #00ff84;
      color: #000;
      font-weight: 700;
      width: 28px;
      height: 28px;
      border-radius: 6px;
    }

    .total-box {
        display: flex;
        justify-content: center;
        padding: 0;
        margin: 0;
        margin-bottom: 3.5rem;
    }
    .total-input {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 1rem;
      color: #000;
      width: 85%;
    }

    .btn-cart {
      background-color: #24D301;
      color: #000;
      font-weight: 600;
      width: 90%;
      max-width: 350px;
      border-radius: 8px;
      padding: 0.75rem;
      display: block;
      margin: 1rem auto;
    }

    .btn-cart:hover {
      background-color: #2ff500;
      color: #000;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark" style="background-color: #24D301;">
  <div class="container-fluid d-flex justify-content-between align-items-center ms-1 me-1">

    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral" aria-controls="menuLateral">
      <span class="navbar-toggler-icon"></span>
    </button>

    <a class="navbar-brand fw-bold text-dark" href="#">
      <img src="./assets/img/logo.png" alt="Logo" height="30">
    </a>

    <div class="d-flex align-items-center gap-3">
  <a href="carrinho.html" class="text-dark position-relative" aria-label="Abrir carrinho">
    <i class="bi bi-cart3 fs-2"></i>
    <span id="cart-count-badge"
          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          style="display:none; font-size:.7rem; min-width:1.1rem; height:1.1rem; padding:0; line-height:1.1rem;">
      0
    </span>
  </a>
  <a href="conta.html" class="text-dark" aria-label="Minha conta">
    <i class="bi bi-person-circle fs-2"></i>
  </a>
</div>
</nav>

<div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="menuLateral" aria-labelledby="menuLateralLabel">
  <div class="offcanvas-header">
    <h2 class="offcanvas-title" id="menuLateralLabel">Menu</h2>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
  </div>
  <div class="menu-divider"></div>
  <div class="offcanvas-body">
    <ul class="list-unstyled">
      <li><a href="index.html" class="text-white text-decoration-none d-block py-2">Eventos</a></li>
      <li><a href="sobre.html" class="text-white text-decoration-none d-block py-2">Sobre Nós</a></li>
      <li><a href="#" class="text-white text-decoration-none d-block py-2">Conta</a></li>
      <li><a href="#" class="text-white text-decoration-none d-block py-2">Sair</a></li>
    </ul>
    <div class="d-flex justify-content-start gap-4 mt-3">
  <a href="#" class="text-white fs-1"><i class="bi bi-instagram"></i></a>
  <a href="#" class="text-white fs-1"><i class="bi bi-tiktok"></i></a>
  <a href="#" class="text-white fs-1"><i class="bi bi-whatsapp"></i></a>
</div>
  </div>
</div>

<section class="titulo">
<a href="index.html" class="text-white fs-2 text-decoration-none p-1"><i class="bi bi-arrow-left"></i></a>
<h3 class="title fw-bold mb-0">Adquira seu ingresso</h3>
</section>

<div class="divider mb-4"></div>

  <div class="event-info">
    <img id="evento-img" src="./assets/img/banner-ArvoreDaVida.png" alt="Árvore da Vida">
    <div class="event-details">
      <h5 id="nome-evento"></h5>
      <p id="local-evento"></p>
      <p id="data-evento"></p>
    </div>
  </div>

  <div class="card-section">
    <h6>Ingresso do Evento</h6>
    <div class="item-line">
      <span id="nome-ingresso-evento"></span>
      <div class="d-flex align-items-center gap-3">
        <span id="preco-ingresso-evento" class="price"></span>
        <div class="counter">
          <button>-</button>
          <span>1</span>
          <button>+</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card-section">
    <h6>Ingresso da Excursão</h6>
    <div class="item-line">
      <span id="nome-excursao-evento"></span>
      <div class="d-flex align-items-center gap-3">
        <span id="preco-excursao-evento" class="price"></span>
        <div class="counter">
          <button>-</button>
          <span>1</span>
          <button>+</button>
        </div>
      </div>
    </div>
  </div>

   <div class="total-box">
  <div class="total-input">
    <span>Total:</span>
    <span id="preco-total"></span>
  </div>
  </div>

  <button class="btn btn-cart">Adicionar ao Carrinho</button>


 <script>
  // URL base da API
  const API_BASE = 'http://localhost:8000/api';

  /**
   * Busca um token para autenticação (caso esteja usando JWT).
   * Lista algumas chaves comuns usadas no localStorage.
   */
  function getToken() {
    const candidates = ['token', 'access', 'jwt'];
    for (const k of candidates) {
      const v = localStorage.getItem(k);
      if (v) return v;
    }
    return null;
  }

  // Cabeçalhos base para as requisições
  const baseHeaders = { 'Accept': 'application/json' };
  const jwt = getToken();
  if (jwt) baseHeaders['Authorization'] = `Bearer ${jwt}`;

  /**
   * Lê o parâmetro ?evento=ID da URL, usado para carregar o evento correto.
   */
  function getEventoIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('evento');
  }

  /**
   * Formata a data (yyyy-mm-dd) para dd/mm/yyyy.
   */
  function formatDateTimeBR(isoDate, isoTime) {
    if (!isoDate) return '';
    const [y, m, d] = String(isoDate).split('-').map(Number);
    const date = new Date(y, m - 1, d);
    const dateStr = new Intl.DateTimeFormat('pt-BR', {
      day: '2-digit', month: '2-digit', year: 'numeric'
    }).format(date);

    if (!isoTime) return dateStr;

    return `${dateStr} às ${isoTime.slice(0, 5)}`; // HH:MM
  }

  /**
   * Carrega os dados do evento na API e popula os elementos da página.
   */
  async function loadEvento() {
    const eventoId = getEventoIdFromUrl();
    if (!eventoId) {
      console.warn('Nenhum ID de evento na URL.');
      return;
    }

    try {
      const resp = await fetch(`${API_BASE}/eventos/${eventoId}/`, { headers: baseHeaders });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const ev = await resp.json();

      // Popula título, local, cidade, data, horário e preço
      document.getElementById('evento-nome').textContent   = ev.nome || 'Evento';
      document.getElementById('evento-local').textContent  = ev.local || '';
      document.getElementById('evento-cidade').textContent = ev.cidade || '';
      document.getElementById('evento-data-hora').textContent =
        formatDateTimeBR(ev.data, ev.horario);

      const precoSpan = document.getElementById('evento-preco');
      if (ev.preco !== null && ev.preco !== undefined) {
        precoSpan.textContent = Number(ev.preco).toLocaleString('pt-BR', {
          style: 'currency',
          currency: 'BRL',
        });
      } else {
        precoSpan.textContent = 'Gratuito';
      }

      // Imagem principal do evento
      const mainImg = document.getElementById('evento-imagem');
      if (mainImg) mainImg.src = ev.imagem || './assets/img/placeholder.png';

    } catch (error) {
      console.error('Erro ao carregar evento:', error);
      alert('Não foi possível carregar os detalhes do evento. Tente novamente mais tarde.');
    }
  }

  document.addEventListener('DOMContentLoaded', loadEvento);
</script>




<script>
  // Chave usada para salvar o carrinho no localStorage
  const CART_KEY = 'cart:v1';

  // Formatador de moeda em formato BRL
  const money = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

  /**
   * Wrapper simples para o carrinho no localStorage.
   * Mantém estado em { items: [{ id, nome, preco, qty }], total, updatedAt }.
   */
  const CartStore = {
    load() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || { items: [] }; }
      catch { return { items: [] }; }
    },
    save(state) {
      state.updatedAt = new Date().toISOString();
      state.total = calcTotal(state.items);
      localStorage.setItem(CART_KEY, JSON.stringify(state));
    },
    clear() {
      localStorage.removeItem(CART_KEY);
    }
  };

  /**
   * Soma o total a partir dos itens: preco * quantidade.
   */
  function calcTotal(items) {
    return items.reduce((acc, it) => {
      const price = parseFloat(it.preco) || 0;
      const qty = parseInt(it.qty, 10) || 0;
      return acc + price * qty;
    }, 0);
  }

  /**
   * Lê a quantidade selecionada no input.
   */
  function getQtdSelecionada() {
    const input = document.getElementById('qtd-ingressos');
    const v = parseInt(input?.value || '1', 10);
    return isNaN(v) || v < 1 ? 1 : v;
  }

  /**
   * Monta um objeto de item de carrinho a partir dos dados da página de evento.
   */
  function getEventoAsCartItem() {
    const id = new URLSearchParams(window.location.search).get('evento');
    const nome = document.getElementById('evento-nome')?.textContent || 'Evento';
    const precoText = document.getElementById('evento-preco')?.textContent || '0';

    // Tenta converter de "R$ 123,45" para número
    const precoNumber = Number(
      precoText.replace(/[R$\s.]/g, '').replace(',', '.')
    ) || 0;

    return {
      id,
      nome,
      preco: precoNumber,
      qty: getQtdSelecionada()
    };
  }

  /**
   * Handler do botão "Adicionar ao carrinho".
   * Adiciona ou incrementa item no carrinho e redireciona para a página do carrinho.
   */
  function handleAddToCart() {
    const item = getEventoAsCartItem();
    if (!item.id) {
      alert('Evento inválido.');
      return;
    }

    const state = CartStore.load();
    const existing = state.items.find(x => x.id === item.id);
    if (existing) {
      existing.qty += item.qty;
    } else {
      state.items.push(item);
    }

    CartStore.save(state);

    // redireciona para o carrinho após adicionar
    window.location.href = 'carrinho.html';
  }

  // Associa a função ao botão na tela
  document.getElementById('btn-add-carrinho')?.addEventListener('click', (e) => {
    e.preventDefault();
    handleAddToCart();
  });
</script>


<script src="js/cart-badge.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
