<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrinho de Compras</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'DM Sans', sans-serif;
      height: 90vh;
    }

    .navbar {
      background-color: #24D301;
    }

    .navbar-brand img {
      height: 30px;
    }

    .navbar-toggler-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='black' stroke-width='2' stroke-linecap='round' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    }

    .titulo {
      display: flex;
      align-items: center;
      margin: 1rem;
    }

    h3 {
      padding-left: 0.5rem;
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1.4;
    }

    .divider {
      height: 1px;
      background-color: #e3e3e3;
      margin: 0.5rem 1rem;
    }

    .card-section {
      background-color: #000;
      border-radius: 8px;
      padding: 1rem;
    }

    .card-section h6 {
      font-weight: 700;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    form {
        margin: 0.75rem;
    }
    .form-control {
    display: flex;
    justify-content: center;
    background-color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1rem;
  }

  .form-control:focus {
    box-shadow: none;
    border: 1px solid #00FF84;
  }

  .buttons {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem;
    gap: 1rem;
  }

  .btn-login {
    background-color: #24D301;
    color: #000;
    font-weight: 600;
    border-radius: 8px;
    margin-top: 0.5rem;
    padding: 0.5rem;
  }

  .btn-login:hover {
    background-color: #28ee00;
    color: #000;
  }

/* ============================
   RESPONSIVIDADE GLOBAL
   (aplicar em todas as páginas)
   ============================ */

/* Tablets em diante (>= 768px) */
@media (min-width: 768px) {

  /* Evita body travado em 90vh */
  body {
    height: auto;
    min-height: 100vh;
  }

  /* Centraliza e limita largura dos principais blocos de conteúdo */
  .titulo,
  .title,
  .divider,
  .sobre-nos,
  .texto,
  .card-section,
  .event-info,
  form,
  .total-input,
  .mensagem-final {
    max-width: 960px;
    margin-left: auto;
    margin-right: auto;
  }

  /* Dá um respiro maior no topo da página */
  .titulo,
  .title {
    margin-top: 1.5rem;
  }

  /* Blocos com “card-section” padronizados */
  .card-section {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* Informações de evento ficam mais organizadas em telas médias+ */
  .event-info {
    gap: 1.5rem;
  }

  .event-info img {
    max-width: 160px;
    width: 100%;
    height: auto;
  }

  /* Botões principais com largura confortável em desktop */
  .btn-cart,
  .btn-confirmar,
  .btn-finalizar,
  .btn-voltar {
    width: 100%;
    max-width: 360px;
  }

  /* Telas tipo “conteúdo único” (ex: embarque / resumo) mais compactas */
  .content {
    max-width: 640px;
    margin-left: auto;
    margin-right: auto;
  }
}

/* Monitores grandes (>= 1200px) */
@media (min-width: 1200px) {

  .titulo,
  .title,
  .divider,
  .sobre-nos,
  .texto,
  .card-section,
  .event-info,
  form,
  .total-input,
  .mensagem-final {
    max-width: 1040px;
  }

  /* Se tiver banner na home, ele fica com largura controlada,
     sem ficar “perdido” em telas muito largas */
  .banner-container {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
}

    </style>
</head>
<body>

 <nav class="navbar navbar-dark" style="background-color: #24D301;">
  <div class="container-fluid d-flex justify-content-between align-items-center ms-1 me-1">

    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral" aria-controls="menuLateral">
      <span class="navbar-toggler-icon"></span>
    </button>

    <a class="navbar-brand fw-bold text-dark" href="#">
      <img src="./assets/img/logo.png" alt="Logo" height="30">
    </a>

    <div class="d-flex align-items-center gap-3">
  <a href="carrinho.html" class="text-dark position-relative" aria-label="Abrir carrinho">
    <i class="bi bi-cart3 fs-2"></i>
    <span id="cart-count-badge"
          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          style="display:none; font-size:.7rem; min-width:1.1rem; height:1.1rem; padding:0; line-height:1.1rem;">
      0
    </span>
  </a>
  <a href="conta.html" class="text-dark" aria-label="Minha conta">
    <i class="bi bi-person-circle fs-2"></i>
  </a>
</div>
</nav>

  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="menuLateral" aria-labelledby="menuLateralLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="menuLateralLabel">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="list-unstyled">
        <li><a href="index.html" class="text-white text-decoration-none d-block py-2">Eventos</a></li>
        <li><a href="sobre.html" class="text-white text-decoration-none d-block py-2">Sobre Nós</a></li>
        <li><a href="#" class="text-white text-decoration-none d-block py-2">Conta</a></li>
        <li><a href="#" class="text-white text-decoration-none d-block py-2">Sair</a></li>
      </ul>
      <div class="d-flex justify-content-start gap-4 mt-3">
        <a href="#" class="text-white fs-1"><i class="bi bi-instagram"></i></a>
        <a href="#" class="text-white fs-1"><i class="bi bi-tiktok"></i></a>
        <a href="#" class="text-white fs-1"><i class="bi bi-whatsapp"></i></a>
      </div>
    </div>
  </div>

  <section class="titulo">
    <a href="index.html" class="text-white fs-2 text-decoration-none p-1"><i class="bi bi-arrow-left"></i></a>
    <h3 class="title fw-bold mb-0">Minha conta</h3>
  </section>

  <div class="divider"></div>

    <div class="card-section">
    <h6>Dados Pessoais</h6>

    <!-- Caixa de alertas para mensagens de erro/sucesso -->
    <div id="accountAlert" class="alert d-none" role="alert"></div>

    <form id="accountForm" novalidate>
      <div class="mb-3">
        <input
          id="nome"
          name="nome"
          type="text"
          class="form-control"
          placeholder="Nome"
          required
        >
      </div>

      <div class="mb-3">
        <input
          id="email"
          name="email"
          type="email"
          class="form-control"
          placeholder="E-mail"
          required
        >
      </div>

      <div class="mb-3">
        <input
          id="telefone"
          name="telefone"
          type="tel"
          class="form-control"
          placeholder="Telefone"
          required
        >
      </div>

      <div class="buttons">
        <button id="btnEditar" type="button" class="btn btn-login w-50">Editar</button>
        <button id="btnSalvar" type="button" class="btn btn-login w-50">Salvar</button>
      </div>
    </form>
  </div>

  <!-- Seção de troca de senha -->
  <div class="card-section mt-4">
    
    <!-- Alertas específicos da troca de senha -->
    <div id="passwordAlert" class="alert d-none" role="alert"></div>

    <!-- Formulário de troca de senha, escondido por padrão -->
    <div id="passwordFormContainer" class="d-none">
      <h6>Trocar senha</h6>
      <form id="passwordForm" novalidate>
        <div class="mb-3">
          <input
            id="oldPassword"
            name="oldPassword"
            type="password"
            class="form-control"
            placeholder="Senha atual"
            required
          >
        </div>

        <div class="mb-3">
          <input
            id="newPassword"
            name="newPassword"
            type="password"
            class="form-control"
            placeholder="Nova senha"
            required
          >
        </div>

        <div class="mb-4">
          <input
            id="newPasswordConfirm"
            name="newPasswordConfirm"
            type="password"
            class="form-control"
            placeholder="Confirme a nova senha"
            required
          >
        </div>

        <div class="buttons">
          <button id="btnChangePassword" type="button" class="btn btn-login w-100">
            Alterar senha
          </button>
        </div>
      </form>
    </div>
  </div>


<script>
(function () {
  const CART_KEY = 'cart:v1';
  const badgeEl = document.getElementById('cart-count-badge');
  if (!badgeEl) return;
  // Return total quantity of items currently stored in the cart state
  function getCount() {
    try {
      const state = JSON.parse(localStorage.getItem(CART_KEY) || '{"items":[]}');
      return (state.items || []).reduce((sum, it) => sum + (parseInt(it.qty, 10) || 0), 0);
    } catch { return 0; }
  }

  // Update the visible badge element to show the current cart item count
  function renderBadge() {
    const n = getCount();
    badgeEl.textContent = n;
    badgeEl.style.display = n > 0 ? 'inline-block' : 'none';
  }

  renderBadge();
  window.addEventListener('storage', (e) => { if (e.key === CART_KEY) renderBadge(); });

  // If a global CartStore is present, wrap its save() to refresh the badge after saves
  if (window.CartStore && typeof window.CartStore.save === 'function') {
    const originalSave = window.CartStore.save.bind(window.CartStore);
    window.CartStore.save = function (state) {
      const r = originalSave(state);
      renderBadge();
      return r;
    };
  }

  // Expose a helper so other scripts can trigger a badge update
  window.updateCartCountBadge = renderBadge;
})();
</script>

<script>
  const API_BASE = 'http://localhost:8000/api';

  /**
   * Recupera o token JWT do localStorage.
   * Considera algumas chaves possíveis usadas no projeto.
   */
  function getToken() {
    const keys = ['access', 'token', 'token2'];
    for (const k of keys) {
      const v = localStorage.getItem(k);
      if (v) return String(v).replace(/^"|"$/g, '');
    }
    return null;
  }

  /**
   * Alertas da parte de dados pessoais.
   */
  function showAccountAlert(message, type = 'danger') {
    const box = document.getElementById('accountAlert');
    if (!box) return;
    box.textContent = message;
    box.className = `alert alert-${type}`;
  }

  function clearAccountAlert() {
    const box = document.getElementById('accountAlert');
    if (!box) return;
    box.textContent = '';
    box.className = 'alert d-none';
  }

  /**
   * Alertas da parte de troca de senha.
   */
  function showPasswordAlert(message, type = 'danger') {
    const box = document.getElementById('passwordAlert');
    if (!box) return;
    box.textContent = message;
    box.className = `alert alert-${type}`;
  }

  function clearPasswordAlert() {
    const box = document.getElementById('passwordAlert');
    if (!box) return;
    box.textContent = '';
    box.className = 'alert d-none';
  }

  /**
   * Habilita / desabilita campos do formulário de Dados Pessoais.
   * Usamos readOnly para manter o estilo, mas evitar edição.
   */
  function setFormDisabled(disabled) {
    ['nome', 'email', 'telefone'].forEach((id) => {
      const input = document.getElementById(id);
      if (input) input.readOnly = disabled;
    });
  }

  /**
   * Divide o nome completo em first_name e last_name.
   */
  function splitNomeCompleto(nome) {
    const parts = (nome || '').trim().split(/\s+/).filter(Boolean);
    if (!parts.length) return { first_name: '', last_name: '' };
    if (parts.length === 1) return { first_name: parts[0], last_name: '' };
    return {
      first_name: parts[0],
      last_name: parts.slice(1).join(' '),
    };
  }

  /**
   * Carrega os dados do usuário em /usuarios/me/ e preenche o formulário.
   */
  async function carregarPerfil() {
    clearAccountAlert();

    const token = getToken();
    if (!token) {
      // Sem token -> redireciona para login
      window.location.href = 'login.html';
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/usuarios/me/`, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
      });

      if (res.status === 401) {
        // Token inválido/expirado
        window.location.href = 'login.html';
        return;
      }

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      const data = await res.json();

      // Monta nome completo a partir de first_name + last_name
      const nomeCompleto = [data.first_name, data.last_name]
        .filter(Boolean)
        .join(' ');

      document.getElementById('nome').value     = nomeCompleto;
      document.getElementById('email').value    = data.email || '';
      document.getElementById('telefone').value = data.telefone || '';

      // Campos começam desabilitados (somente leitura)
      setFormDisabled(true);
    } catch (err) {
      console.error(err);
      showAccountAlert(
        'Não foi possível carregar seus dados. Tente novamente mais tarde.',
        'danger'
      );
    }
  }

  /**
   * Envia as alterações de Nome / E-mail / Telefone para o backend via PATCH.
   */
  async function salvarPerfil() {
    clearAccountAlert();

    const token = getToken();
    if (!token) {
      window.location.href = 'login.html';
      return;
    }

    const nomeInput     = document.getElementById('nome');
    const emailInput    = document.getElementById('email');
    const telefoneInput = document.getElementById('telefone');

    const nome     = (nomeInput.value || '').trim();
    const email    = (emailInput.value || '').trim();
    const telefone = (telefoneInput.value || '').trim();

    if (!nome)  return showAccountAlert('Informe seu nome.', 'warning');
    if (!email) return showAccountAlert('Informe seu e-mail.', 'warning');

    const { first_name, last_name } = splitNomeCompleto(nome);

    // Payload compatível com PerfilSerializer (campos de user + perfil "achatados")
    const payload = {
      first_name,
      last_name,
      email,
      telefone,
    };

    try {
      const res = await fetch(`${API_BASE}/usuarios/me/`, {
        method: 'PATCH',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        console.error('Erro ao atualizar perfil:', data);
        const msg =
          data.detail ||
          (Array.isArray(data.non_field_errors) && data.non_field_errors[0]) ||
          'Não foi possível salvar seus dados. Verifique os campos e tente novamente.';
        showAccountAlert(msg, 'danger');
        return;
      }

      showAccountAlert('Dados atualizados com sucesso!', 'success');
      setFormDisabled(true);
    } catch (err) {
      console.error(err);
      showAccountAlert(
        'Erro de conexão ao salvar seus dados. Tente novamente.',
        'danger'
      );
    }
  }

  /**
   * Troca de senha via /auth/change-password/.
   */
  async function trocarSenha() {
    clearPasswordAlert();

    const token = getToken();
    if (!token) {
      window.location.href = 'login.html';
      return;
    }

    const oldInput  = document.getElementById('oldPassword');
    const newInput  = document.getElementById('newPassword');
    const confInput = document.getElementById('newPasswordConfirm');

    const oldPassword        = (oldInput?.value || '').trim();
    const newPassword        = (newInput?.value || '').trim();
    const newPasswordConfirm = (confInput?.value || '').trim();

    if (!oldPassword)
      return showPasswordAlert('Informe sua senha atual.', 'warning');
    if (!newPassword)
      return showPasswordAlert('Informe a nova senha.', 'warning');
    if (!newPasswordConfirm)
      return showPasswordAlert('Confirme a nova senha.', 'warning');

    try {
      const res = await fetch(`${API_BASE}/auth/change-password/`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({
          old_password: oldPassword,
          new_password: newPassword,
          new_password_confirm: newPasswordConfirm,
        }),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        console.error('Erro ao trocar senha:', data);
        let msg = data.detail;
        if (!msg && typeof data === 'object' && data !== null) {
          const firstKey = Object.keys(data)[0];
          if (firstKey && Array.isArray(data[firstKey]) && data[firstKey][0]) {
            msg = data[firstKey][0];
          }
        }
        showPasswordAlert(
          msg || 'Não foi possível alterar a senha. Verifique os dados e tente novamente.',
          'danger'
        );
        return;
      }

      showPasswordAlert('Senha alterada com sucesso. Faça login novamente.', 'success');

      if (oldInput)  oldInput.value  = '';
      if (newInput)  newInput.value  = '';
      if (confInput) confInput.value = '';

      // Força logout: remove tokens locais
      ['access', 'refresh', 'token', 'token2'].forEach((k) =>
        localStorage.removeItem(k)
      );

      setTimeout(() => {
        window.location.href = 'login.html';
      }, 2000);
    } catch (err) {
      console.error(err);
      showPasswordAlert(
        'Erro de conexão ao tentar alterar a senha. Tente novamente.',
        'danger'
      );
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Carrega os dados do usuário assim que abrir a página
    carregarPerfil();

    // Botão "Editar" de Dados Pessoais: habilita os campos
    const btnEditar = document.getElementById('btnEditar');
    if (btnEditar) {
      btnEditar.addEventListener('click', (e) => {
        e.preventDefault();
        clearAccountAlert();
        setFormDisabled(false);
        document.getElementById('nome')?.focus();
        const container = document.getElementById('passwordFormContainer');
        if (container) container.classList.remove('d-none');
        document.getElementById('oldPassword')?.focus();
      });
    }

    // Botão "Salvar" de Dados Pessoais
    const btnSalvar = document.getElementById('btnSalvar');
    if (btnSalvar) {
      btnSalvar.addEventListener('click', (e) => {
        e.preventDefault();
        salvarPerfil();
      });
    }

    // Evita submit padrão do form de dados pessoais
    const accountForm = document.getElementById('accountForm');
    if (accountForm) {
      accountForm.addEventListener('submit', (e) => e.preventDefault());
    }

    // Botão "Alterar senha" envia para /auth/change-password/
    const btnChangePassword = document.getElementById('btnChangePassword');
    if (btnChangePassword) {
      btnChangePassword.addEventListener('click', (e) => {
        e.preventDefault();
        trocarSenha();
      });
    }

    // Evita submit padrão do form de senha
    const passwordForm = document.getElementById('passwordForm');
    if (passwordForm) {
      passwordForm.addEventListener('submit', (e) => e.preventDefault());
    }
  });
</script>




<script src="js/cart-badge.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>